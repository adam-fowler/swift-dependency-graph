<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <style src="https://fonts.googleapis.com/css?family=Lato:300,400"></style>
        <link rel="stylesheet" type="text/css" href="filter.css">
        <script src="filter.js"></script>
        <style>
            body {
                font-size: 10px;
                font-size: 1rem;
                font-family: "Lato", sans-serif;
                font-weight: 300;
                background-color:#eee;
                background-repeat: no-repeat;
                background-position: center;
                background-size: auto;
                background-attachment: fixed;
            }
            .packagetitle {
                font-weight: 400;
                min-width: 60px;
            }
            .packageowner {
                font-weight: 300;
                font-size: 90%;
            }
            #chart_div {
                width: 100%;
            }
        </style>
        <script type="text/javascript">
            google.charts.load('current', {packages:["orgchart"]});
            google.charts.setOnLoadCallback(loadDependencies);

            var direction = "to"
            var dependencyData
            var rootName = ""
            var nodeId = 0

            function loadDependencies() {
                $.ajax({
                       url : "https://raw.githubusercontent.com/adam-fowler/swift-dependency-graph/master/dependencies.json",
                       success : function (data) {
                           dependencyData = JSON.parse(data)
                           let keys = Object.keys(dependencyData)
                           let filterNames = keys.map(function(name) {return displayName(name)})
                           setFilterListOptions(filterNames, keys, "selectRoot")
                           drawChart();
                       }
                       });
            }

            function selectRoot(name) {
                rootName = name
                hideFilterList()
                drawChart()
            }

            function displayName(name) {
                let split = name.split("/")
                if (split.length >= 2) {
                    return `${split[split.length-2]}/${split[split.length-1]}`
                }
                return name
            }

            function renderName(name) {
                let split = name.split("/")
                if (split.length >= 2) {
                    var html = []
                    html.push("<div class='packagetitle'>")
                    html.push(split[split.length-1])
                    html.push("</div>")
                    html.push("<div class='packageowner'>")
                    html.push(split[split.length-2])
                    html.push("</div>")
                    return html.join("")
                }
                return name
            }

            function addRows(data, rootName, level, rootNameCount) {
                nodeId += 1
                if (level == 0) {
                    return
                }
                let nodeId2 = nodeId
                let root = dependencyData[rootName]
                data.addRows(root[direction].map(function(name){return [{v:name+nodeId2, f:renderName(name)}, rootNameCount, name]}))
                for(entry in root[direction]) {
                    let rootName = root[direction][entry]
                    addRows(data, rootName, level-1, rootName+nodeId2)
                }

            }
            function drawChart() {
                var data = new google.visualization.DataTable();

                data.addColumn('string', 'Name');
                data.addColumn('string', 'Parent');
                data.addColumn('string', 'ToolTip');

                let root = dependencyData[rootName]
                nodeCount = 0
                data.addRows([[{v:rootName, f:renderName(rootName)}, "", rootName]]);
                addRows(data, rootName, 5, rootName)

                // Create the chart.
                var chart = new google.visualization.OrgChart(document.getElementById('chart_div'));

                // set background
                var backgroundImages = {"to" : "images/solid-arrow-circle-up.svg", "on" : "images/solid-arrow-circle-down.svg"}
                document.body.style.backgroundImage = `url(${backgroundImages[direction]})`

                // Draw the chart, setting the allowHtml option to true for the tooltips.
                chart.draw(data, {allowHtml:true});

                google.visualization.events.addListener(chart, "select", function() {
                    let selection = chart.getSelection()
                    let newRoot = data.getValue(selection[0].row, 2)
                    if (newRoot == rootName) {
                        if (direction == "on") { direction = "to" } else { direction = "on" }
                    } else {
                        rootName = newRoot
                        if (direction == "on" && dependencyData[rootName].on.length == 0) {
                            direction = "to"
                        }
                        if (direction == "to" && dependencyData[rootName].to.length == 0) {
                            direction = "on"
                        }
                    }
                    drawChart()
                })
            }
        </script>
    </head>
    <body>
        <div id="filter">
            <input type="text" id="filterInput" onkeyup="filterList()" placeholder="Search for packages..">
            <ul id="filterList"></ul>
        </div>
        <div id="chart_div"></div>
    </body>
</html>
