<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script type="text/javascript">
            google.charts.load('current', {packages:["orgchart"]});
            google.charts.setOnLoadCallback(loadDependencies);

            var direction = "to"
            var dependencyData
            var rootName = "https://github.com/apple/swift-nio"

            function loadDependencies() {
                $.ajax({
                       url : "https://raw.githubusercontent.com/adam-fowler/swift-dependency-graph/master/dependencies.json",
                       success : function (data) {
                           dependencyData = JSON.parse(data)
                           drawChart();
                       }
                       });
            }

            function visibleName(name) {
                let split = name.split("/")
                if (split.length >= 2) {
                    return split[split.length-2] + " " + split[split.length-1]
                }
                return name
            }

            function addRows(data, rootName, level) {
                if (level == 0) {
                    return
                }
                let root = dependencyData[rootName]
                data.addRows(root[direction].map(function(name){return [visibleName(name), visibleName(rootName), name]}))
                for(entry in root[direction]) {
                    let rootName = root[direction][entry]
                    addRows(data, rootName, level-1)
                }

            }
            function drawChart() {
                var data = new google.visualization.DataTable();

                data.addColumn('string', 'Name');
                data.addColumn('string', 'Parent');
                data.addColumn('string', 'ToolTip');

                let root = dependencyData[rootName]
                data.addRows([[visibleName(rootName), "", rootName]]);
                addRows(data, rootName, 5)

                // Create the chart.
                var chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
                // Draw the chart, setting the allowHtml option to true for the tooltips.
                chart.draw(data, {allowHtml:true});

                google.visualization.events.addListener(chart, "select", function() {
                    let selection = chart.getSelection()
                    let newRoot = data.getValue(selection[0].row, 2)
                    if (newRoot == rootName) {
                        if (direction == "on") { direction = "to" } else { direction = "on" }
                    } else {
                        rootName = newRoot
                        if (direction == "on" && dependencyData[rootName].on.length == 0) {
                            direction = "to"
                        }
                        if (direction == "to" && dependencyData[rootName].to.length == 0) {
                            direction = "on"
                        }
                    }
                    drawChart()
                })
            }
        </script>
    </head>
    <body>
        <div id="chart_div"></div>
    </body>
</html>
