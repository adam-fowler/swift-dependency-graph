<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-32652209-5"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-32652209-5');
        </script>
        <meta charset="UTF-8">
        <meta name="description" content="Visualisation of swift package dependencies">
        <meta name="author" content="Adam Fowler">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <style src="https://fonts.googleapis.com/css?family=Lato:300,400"></style>
        <link rel="stylesheet" type="text/css" href="filter.css">
        <script src="filter.js"></script>
        <style>
            body {
                font-size: 10px;
                font-size: 1rem;
                font-family: "Lato", sans-serif;
                font-weight: 300;
                background-color:#eee;
                background-repeat: no-repeat;
                background-position: center;
                background-size: auto;
                background-attachment: fixed;
            }
            .chart-node {
                text-align: left;
                vertical-align: middle;
                border: 1px solid #b5d9ea;
                padding: 0;
                -webkit-border-radius: 3px;
                -webkit-box-shadow: rgba(0, 0, 0, 0.5) 3px 3px 3px;
                background-color: #edf7ff;
                background: -webkit-gradient(linear, left top, left bottom, from(#edf7ff), to(#cde7ee));
            }
            .packagetitle {
                font-weight: 400;
                min-width: 60px;
            }
            .packageowner {
                font-weight: 300;
                font-size: 70%;
            }
            .packagelink {
                /*position: relative;
                display: block;
                width: 16px;
                height: 16px;
                top: 2px;
                right: 2px;*/
            }
            .packagelink img {
                vertical-align: middle;
            }
            /* override google-visualization-orgchart-table styles for links and images */
            .google-visualization-orgchart-table a {
                padding: 0px;
            }
            .google-visualization-orgchart-table img {
                padding: 0px;
            }

            #details {
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: 300px;
                max-width: 85%;
                background-color: #ccc;
                padding: 12px;
                font-size: 80%;
            }
            #minimize-button {
                position: absolute;
                display: block;
                top: 5px;
                right: 5px;
                padding: 1px 2px 1px 2px; /* Add some padding */
                border: 1px solid #000;
                font-size: 60%;
            }
            #chart_div {
                width: 100%;
            }

            @media screen and (max-width: 480px) {
                body {
                     font-size: 80%;
                }
                #details {
                    bottom: 12px;
                    left: 12px;
                    padding: 8px;
                }
            }
        </style>
        <script type="text/javascript">
            google.charts.load('current', {packages:["orgchart"]});
            google.charts.setOnLoadCallback(loadDependencies);

            var chart
            var chart_data
            var direction = "on"
            var dependencyData
            var rootName = "https://github.com/adam-fowler/swift-dependency-graph"
            var nodeId = 0

            function createChart() {
                // Create the chart.
                let container = document.getElementById('chart_div')
                chart = new google.visualization.OrgChart(container);

                container.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (e.target.tagName.toUpperCase() === 'A') {
                        chart.setSelection([]);
                        gtag('event', 'view_link', {'event_label' : e.target.href})
                        window.open(e.target.href, "_blank");
                        drawChart()
                    } else if (e.target.parentElement.tagName.toUpperCase() === 'A') {
                        chart.setSelection([]);
                        gtag('event', 'view_link', {'event_label' : e.target.parentElement.href})
                        window.open(e.target.parentElement.href, "_blank");
                        drawChart()
                    } else {
                        let selection = chart.getSelection()
                        if (selection.length == 0) {
                            return
                        }
                        let newRoot = chart_data.getValue(selection[0].row, 0).split('#')[0]

                        if (newRoot == rootName) {
                            if (direction == "on") { direction = "to" } else { direction = "on" }
                        } else {
                            rootName = newRoot
                        }
                        chart.setSelection([]);
                        drawChart();
                    }
                }, false);

            }

            function loadDependencies() {
                $.ajax({
                       url : "https://raw.githubusercontent.com/adam-fowler/swift-dependency-graph/master/dependencies.json?v1",
                       success : function (data) {
                           dependencyData = JSON.parse(data)
                           let keys = Object.keys(dependencyData)
                           let filterNames = keys.map(function(name) {return displayName(name)})
                           setFilterListOptions(filterNames, keys, "selectRoot")
                           createChart();
                           drawChart()
                       }
                       });
            }

            function selectRoot(name) {
                rootName = name
                gtag('event', 'view_package', {'event_label' : rootName})
                direction = "on"
                hideFilterList()
                drawChart()
            }

            function displayName(name) {
                let split = name.split("/")
                if (split.length >= 2) {
                    return `${split[split.length-2]}/${split[split.length-1]}`
                }
                return name
            }

            function renderName(name) {
                let split = name.split("/")
                if (split.length >= 2) {
                    var html = []
                    html.push(`<div class='packagetitle'>${split[split.length-1]}</div>`)
                    html.push(`<div class='packageowner'>${split[split.length-2]}`)
                    html.push(`<a class='packagelink' href='${name}'><img src='images/pagelink.svg'/></a></div>`)
                    return html.join("")
                }
                return name
            }

            function tooltipForName(name) {
                let node = dependencyData[name]
                if (node.error === "FailedToLoad") {
                    return `${name}\nDependencies unavailable. Cannot find a Package.swift on the 'master' branch`
                } else if(node.error === "InvalidManifest") {
                    return `${name}\nDependencies unavailable. Failed to load Package.swift.\nEither it is corrupt or is an unsupported version.\nVersions supported range from 4.0 to 5.0.`
                } else if(node.error === "Unknown") {
                    return `${name}\nDependencies unavailable. Failed to load Package.swift`
                }
                return name
            }

            function addRows(data, rootName, level, rootNameCount) {
                nodeId += 1
                if (level == 0) {
                    return
                }
                let nodeId2 = nodeId
                let root = dependencyData[rootName]
                data.addRows(root[direction].map(function(name){return [{v:`${name}#${nodeId2}`, f:renderName(name)}, rootNameCount, tooltipForName(name)]}))
                for(entry in root[direction]) {
                    let rootName = root[direction][entry]
                    addRows(data, rootName, level-1, `${rootName}#${nodeId2}`)
                }

            }
            function drawChart() {
                chart_data = new google.visualization.DataTable();

                chart_data.addColumn('string', 'Name');
                chart_data.addColumn('string', 'Parent');
                chart_data.addColumn('string', 'ToolTip');

                let root = dependencyData[rootName]
                nodeCount = 0
                chart_data.addRows([[{v:rootName, f:renderName(rootName)}, "", tooltipForName(rootName)]]);
                addRows(chart_data, rootName, 5, rootName)

                // set background
                var backgroundImages = {"to" : "images/solid-arrow-circle-down.svg", "on" : "images/solid-arrow-circle-up.svg"}
                document.body.style.backgroundImage = `url(${backgroundImages[direction]})`

                // Draw the chart, setting the allowHtml option to true for the tooltips.
                chart.draw(chart_data, {allowHtml:true, nodeClass:"chart-node", selectedNodeClass:"chart-node"});
            }
        </script>
    </head>
    <body>
        <div id="filter">
            <input type="text" id="filterInput" onkeyup="filterList()" placeholder="Search for packages..">
            <ul id="filterList"></ul>
        </div>
        <div id="details" class="maximized">
            <h3>Swift Dependency Graph</h3>
            <p>Start to type the name of a package in the search bar and select from the menu to display a package and its dependencies. Click on a node in the graph to make that the top node. Click on the top node to toggle between displaying a package's dependencies and displaying the packages dependent on it.</p>
            <p>The arrow in the background indicates whether you are displaying dependents or dependencies. The arrow always points in the direction of the parent or dependent package.</p>
            <p>The swift dependency graph uses the Swift Package catalog from the <a href="https://swiftpm.co/">SwiftPMLibrary</a> setup by Dave Verwer. The graph is written by <a href="https://github.com/adam-fowler">Adam Fowler</a>.</p>
        </div>
        <div id="chart_div"></div>
    </body>
</html>
